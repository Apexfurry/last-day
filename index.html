<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LAST DAY</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://wsrv.nl">
<link rel="dns-prefetch" href="https://wsrv.nl">
<link rel="preconnect" href="https://image.tmdb.org">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;800&family=Syncopate:wght@700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<style>
/* --- CORE VARIABLES --- */
:root {
    --bg: #050505;
    --primary: #00ff41;
    --accent: #ff0055;
    --text: #ffffff;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', sans-serif;
    overflow: hidden; 
    height: 100vh;
}

/* =========================
   FAST LOADER
   ========================= */
#loader {
    position: fixed; inset: 0; z-index: 10000;
    background: #000;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    transition: opacity 0.3s;
}
.loader-text {
    font-family: 'Syncopate', sans-serif; color: var(--primary);
    font-size: 1rem; letter-spacing: 3px; margin-bottom: 20px;
    text-transform: uppercase;
}
.loader-bar {
    width: 150px; height: 1px; background: #333; position: relative; overflow: hidden;
}
.loader-progress {
    position: absolute; top: 0; left: 0; height: 100%; width: 0%;
    background: var(--primary); transition: width 0.1s linear;
}

/* =========================
   PAGE 1: INTRO
   ========================= */
#intro-overlay {
    display: none; 
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: 9999; 
    background: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #000000 70%);
    overflow: hidden;
    perspective: 1000px;
}
#intro-overlay::after {
    content: ""; position: absolute; inset: 0;
    background-image: linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                      linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
    background-size: 60px 60px; pointer-events: none;
}
.center-title {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    z-index: 50;
    font-family: 'Syncopate', sans-serif; font-weight: 700; font-size: 0.9rem;
    letter-spacing: 4px; color: #fff; cursor: pointer; text-transform: uppercase;
    transition: all 0.3s; pointer-events: auto;
    text-shadow: 0 0 20px rgba(255,255,255,0.2);
    padding: 40px; 
}
.center-title:hover {
    color: var(--primary); text-shadow: 0 0 40px var(--primary); letter-spacing: 6px;
}
#ring-wrap { position: absolute; top: 50%; left: 50%; width: 0; height: 0; z-index: 100; }
.ring-item {
    position: absolute; top: -90px; left: -60px;
    width: 120px; height: 180px;
    background-size: cover; background-position: center;
    border: 1px solid rgba(255,255,255,0.15);
    cursor: default;
    will-change: transform; transform: translateZ(0); 
    transition: opacity 0.2s, filter 0.2s;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
#ring-wrap.dimmed .ring-item { opacity: 0.15; filter: grayscale(100%) blur(1px); pointer-events: none; }
#inspector {
    position: absolute; top: 50%; left: 50%;
    width: 120px; height: 180px; 
    background-size: cover; background-position: center;
    image-rendering: -webkit-optimize-contrast;
    z-index: 1000; display: none; pointer-events: auto; cursor: default;
    border: 1px solid #fff; box-shadow: 0 30px 80px rgba(0,0,0,0.9);
}

/* =========================
   PAGE 2: MAIN APP
   ========================= */
#app-container {
    display: none; opacity: 0; height: 100vh; overflow-y: auto;
    position: relative; z-index: 50;
    background: #080808;
}
.bg-grid {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px; pointer-events: none; z-index: -1;
}
header {
    position: fixed; top: 0; left: 0; right: 0; height: 80px;
    background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255,255,255,0.1); 
    display: flex; align-items: center; justify-content: space-between; 
    padding: 0 40px; z-index: 100;
}
#return-btn {
    font-family: 'Syncopate', sans-serif; font-weight: 700; font-size: 0.9rem; color: #888; 
    cursor: pointer; text-transform: uppercase; transition: color 0.3s, transform 0.3s; 
    display: flex; align-items: center; gap: 10px;
}
#return-btn::before { content: '←'; font-family: 'Inter'; font-size: 1.2rem; }
#return-btn:hover { color: #fff; transform: translateX(-5px); }

/* --- HEADER RIGHT: ACTIONS + SEARCH --- */
.header-right {
    display: flex;
    align-items: center;
    gap: 15px; 
}

/* SEARCH ICON BUTTON */
#header-search-btn {
    background: transparent; 
    border: none; 
    padding: 10px;
    cursor: pointer; 
    color: #fff;
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.2s, color 0.2s;
}
#header-search-btn svg { width: 28px; height: 28px; fill: currentColor; }
#header-search-btn:hover { transform: scale(1.1); color: var(--primary); }

/* SELECTION ACTION BUTTONS */
.action-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; 
    pointer-events: none; 
    transform: scale(0.8);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.action-btn svg { width: 24px; height: 24px; }

/* Visible State */
.action-btn.visible {
    opacity: 1;
    pointer-events: auto;
    transform: scale(1);
}

#btn-fav { color: var(--accent); } 
#btn-fav:hover { transform: scale(1.2); filter: drop-shadow(0 0 8px var(--accent)); }

#btn-del { color: #fff; } 
#btn-del:hover { color: #ccc; transform: scale(1.2); }


#main-grid { margin-top: 100px; padding: 0 40px 40px 40px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 30px; }

/* CARD STYLES */
.card { 
    position: relative; aspect-ratio: 2/3; background: #1a1a1a; 
    cursor: pointer; transition: transform 0.2s, border-color 0.2s; 
    overflow: hidden; border: 1px solid #333; 
    user-select: none; 
}
.card-img { 
    width: 100%; height: 100%; object-fit: cover; 
    filter: grayscale(0%); 
    transition: transform 0.4s;
    background: #111; 
}
/* SELECTED STATE */
.card.selected {
    border: 3px solid #fff; 
    transform: scale(0.95);
    z-index: 20;
    box-shadow: 0 0 20px rgba(255,255,255,0.2);
}

/* --- UPDATED FAVORITE MARKER (Bottom Right) --- */
.fav-marker {
    position: absolute;
    bottom: 8px; /* Fixed: Bottom */
    right: 8px;  /* Fixed: Right */
    color: var(--accent);
    font-size: 16px; /* Very small */
    z-index: 25; /* On top of everything */
    filter: drop-shadow(0 1px 3px rgba(0,0,0,1)); /* Contrast shadow */
    pointer-events: none;
}

.card:hover { 
    transform: translateY(-8px); z-index: 10; 
    border-color: var(--primary); 
    box-shadow: 0 10px 30px rgba(0, 255, 65, 0.1);
}
.card.selected:hover {
    transform: scale(0.95) translateY(-4px);
    border-color: #fff;
}

.card:hover .card-img { transform: scale(1.05); } 
.card-overlay { 
    position: absolute; bottom: 0; left: 0; right: 0; 
    background: rgba(0,0,0,0.9); padding: 15px; 
    transform: translateY(100%); transition: transform 0.2s; 
    border-top: 1px solid var(--primary);
}
.card:hover .card-overlay { transform: translateY(0); }
.card-title { font-family: 'Inter', sans-serif; font-weight: 700; font-size: 0.8rem; color: #fff; }
.card-year { font-family: 'Syncopate'; font-size: 0.7rem; color: var(--primary); margin-top: 4px; }

.controls { position: fixed; bottom: 40px; right: 40px; display: flex; flex-direction: column; gap: 12px; z-index: 200; }
.btn { background: #000; color: var(--text); border: 1px solid #333; padding: 14px 24px; font-family: 'Inter', sans-serif; font-size: 0.8rem; font-weight: 600; cursor: pointer; text-transform: uppercase; transition: all 0.2s; display: flex; align-items: center; justify-content: space-between; gap: 20px; min-width: 160px; }
.btn:hover { background: #fff; color: #000; }

/* SCROLL TO TOP BUTTON */
#btn-top {
    position: fixed; 
    bottom: 40px; 
    left: 40px; 
    width: 30px; 
    height: 30px; 
    background: transparent; 
    border: 1px solid #333; 
    color: #555; 
    font-size: 1rem; 
    cursor: pointer; 
    z-index: 400;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.3s;
}
#btn-top:hover {
    border-color: var(--primary);
    color: var(--primary);
    transform: translateY(-3px);
}

/* =========================
   SEARCH OVERLAY
   ========================= */
#search-overlay { 
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
    background: rgba(5,5,5,0.98); 
    z-index: 300; 
    display: none; flex-direction: column; 
    padding: 0; 
    align-items: center; 
}

.search-header-fixed {
    width: 100%;
    padding: 20px 40px; 
    background: rgba(5,5,5,0.98);
    border-bottom: 1px solid #333;
    display: flex; align-items: center;
    justify-content: space-between; 
    position: sticky; top: 0; z-index: 20;
}

.search-bar-wrap { 
    flex-grow: 0; 
    width: 250px; 
    border-bottom: 2px solid #333; 
    display: flex; align-items: center; 
}

#search-input { 
    width: 100%; background: transparent; border: none; 
    color: #fff; font-family: 'Syncopate', sans-serif; 
    font-weight: 700; 
    font-size: 1.5rem; 
    outline: none; text-transform: uppercase; 
    padding: 5px 0;
    caret-color: transparent; 
}
#search-input:not(:placeholder-shown) { caret-color: #fff; }
#search-input::placeholder { color: #333; font-size: 1rem; }

#close-search { 
    font-size: 1.5rem; 
    cursor: pointer; color: #555; transition: color 0.3s; 
}
#close-search:hover { color: #fff; }

#search-scroll-area {
    flex-grow: 1;
    overflow-y: auto;
    padding: 40px; 
    width: 100%;
}

#search-results { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
    gap: 30px; 
    padding-bottom: 100px; 
    width: 100%;
}

#empty-state { position: fixed; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; opacity: 0.3; }
#empty-state h1 { font-family: 'Syncopate'; font-size: 4rem; letter-spacing: 10px; }

/* --- TOAST --- */
#toast { 
    position: fixed; 
    top: 100px; 
    right: 30px; 
    background: var(--primary); 
    color: #000; 
    padding: 15px 30px; 
    font-family: 'Syncopate'; 
    font-weight: 700; 
    font-size: 0.8rem; 
    z-index: 500; 
    cursor: pointer;
    transform: translateX(120%); 
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
    will-change: transform;
}
</style>
</head>
<body>

<div id="loader">
    <div class="loader-text">holy fuck</div>
    <div class="loader-bar"><div class="loader-progress" id="progress-bar"></div></div>
</div>

<div id="intro-overlay">
    <div class="center-title" id="enter-trigger">LAST DAY</div>
    <div id="ring-wrap"></div>
    <div id="inspector"></div>
</div>

<div id="app-container">
    <div class="bg-grid"></div>
    <header>
        <div id="return-btn">RETURN</div>
        
        <div class="header-right">
            <button class="action-btn" id="btn-fav" title="Favorite Selected">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            </button>
            
            <button class="action-btn" id="btn-del" title="Delete Selected">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>

            <button id="header-search-btn" title="Search [S]">
                <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            </button>
        </div>
    </header>
    
    <div id="main-grid"></div>
    <div id="empty-state"><h1>NULL</h1><p>NO RECORDS FOUND</p></div>
    
    <div class="controls">
        <button class="btn" id="btn-share"><span>Share</span> <span>☍</span></button>
        <button class="btn" id="btn-import" style="display:none; border-color: var(--accent); color: var(--accent);"><span>Import</span> <span>⇩</span></button>
    </div>
    
    <button id="btn-top" title="Scroll to Top">↑</button>
    
    <div id="search-overlay">
        <div class="search-header-fixed">
            <div class="search-bar-wrap">
                <input type="text" id="search-input" placeholder="SEARCH" autocomplete="off">
            </div>
            <div id="close-search">✕</div>
        </div>
        <div id="search-scroll-area">
            <div id="search-results"></div>
        </div>
    </div>
    
    <div id="toast">SUCCESS</div>
</div>

<script>
// --- GLOBAL STATE ---
let ringActive = true;
let savedMovies = [];
let isSharedMode = false;
let toastTimer = null; 
let selectedIDs = new Set();

// --- CONFIGURATION ---
const TMDB_KEY = "c968ffe14a9765f4d45f36e4d87b27b2";
const PLACEHOLDER = "https://via.placeholder.com/300x450/111/333?text=NO+IMG";
const PROXY_BASE = "https://wsrv.nl/?url=https://image.tmdb.org/t/p/"; 

// --- FIREBASE INIT ---
const firebaseConfig = {
    apiKey: "AIzaSyCt6s0fVkb7DtQeq9H05wg_D0Lw_S10-0",
    authDomain: "lastday-18.firebaseapp.com",
    projectId: "lastday-18",
    storageBucket: "lastday-18.firebasestorage.app",
    messagingSenderId: "413600100426",
    appId: "1:413600100426:web:c55e5c7fd46028a26236b3"
};
try { firebase.initializeApp(firebaseConfig); window.db = firebase.firestore(); } catch (e) { console.warn("Firebase offline"); }

// --- DOM ELEMENTS ---
let mainGrid, emptyState, searchOverlay, searchInput, searchResults, toast, loader, introOverlay, appContainer, btnTop;
let btnFav, btnDel; 

// --- STARTUP LOGIC ---
window.addEventListener('DOMContentLoaded', async () => {
    mainGrid = document.getElementById('main-grid');
    emptyState = document.getElementById('empty-state');
    searchOverlay = document.getElementById('search-overlay');
    searchInput = document.getElementById('search-input');
    searchResults = document.getElementById('search-results');
    toast = document.getElementById('toast');
    btnTop = document.getElementById('btn-top');
    btnFav = document.getElementById('btn-fav');
    btnDel = document.getElementById('btn-del');
    
    if(toast) {
        toast.onclick = () => {
            clearTimeout(toastTimer);
            toast.style.transform = "translateX(120%)"; // HIDE
        };
    }

    loader = document.getElementById('loader');
    introOverlay = document.getElementById('intro-overlay');
    appContainer = document.getElementById('app-container');

    document.getElementById('enter-trigger').onclick = window.triggerEntry;
    document.getElementById('return-btn').onclick = window.triggerReturn;
    document.getElementById('header-search-btn').onclick = () => { 
        if(isSharedMode) return showToast("LOCKED: READ ONLY"); 
        searchOverlay.style.display = 'flex'; searchInput.focus(); 
    };
    document.getElementById('close-search').onclick = () => { searchOverlay.style.display = 'none'; };
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') searchOverlay.style.display = 'none'; });
    searchInput.oninput = () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(performSearch, 500); };
    
    // Scroll To Top
    if(btnTop && appContainer) {
        btnTop.onclick = () => {
            appContainer.scrollTo({ top: 0, behavior: 'smooth' });
        };
    }

    // --- ACTION BUTTON LOGIC ---
    if(btnFav) {
        btnFav.onclick = () => {
            if(selectedIDs.size === 0) return;
            // Toggle favorite status
            savedMovies = savedMovies.map(m => {
                if(selectedIDs.has(m.imdbID)) {
                    m.isFavorite = !m.isFavorite; // Toggle
                }
                return m;
            });
            localStorage.setItem("savedMovies", JSON.stringify(savedMovies));
            showToast("UPDATED FAVORITES");
            selectedIDs.clear(); 
            updateSelectionUI();
            render();
        };
    }

    if(btnDel) {
        btnDel.onclick = () => {
            if(selectedIDs.size === 0) return;
            if(confirm(`DELETE ${selectedIDs.size} ITEMS?`)) {
                savedMovies = savedMovies.filter(m => !selectedIDs.has(m.imdbID));
                localStorage.setItem("savedMovies", JSON.stringify(savedMovies));
                showToast("DELETED SELECTED");
                selectedIDs.clear();
                updateSelectionUI();
                render();
            }
        };
    }

    const params = new URLSearchParams(location.search);
    const viewId = params.get("view");
    
    if (viewId) {
        document.querySelector('.loader-text').innerText = "SYNCING...";
        await initSharedMode(viewId);
    } else {
        introOverlay.style.display = 'block';
        loadLocalData();
        buildRing(); 
    }

    setTimeout(() => {
        if(loader.style.display !== 'none') {
            gsap.to(loader, { opacity: 0, duration: 0.5, onComplete: () => loader.style.display = 'none' });
            gsap.to(introOverlay, { opacity: 1, duration: 0.5 });
            if(!ringActive) { appContainer.style.display = 'block'; gsap.to(appContainer, { opacity: 1 }); }
        }
    }, 4000);
});

async function initSharedMode(viewId) {
    isSharedMode = true;
    const impBtn = document.getElementById('btn-import');
    const shareBtn = document.getElementById('btn-share');
    if(impBtn) impBtn.style.display = 'flex';
    if(shareBtn) shareBtn.innerHTML = `<span>COPY LINK</span> <span>©</span>`;
    
    if(!window.db) { setTimeout(()=>initSharedMode(viewId), 100); return; }

    try {
        const doc = await window.db.collection("shares").doc(viewId).get();
        if (doc.exists) {
            savedMovies = doc.data().movies;
            render();
            gsap.to(loader, { opacity: 0, duration: 0.3, onComplete: () => loader.style.display = 'none' });
            appContainer.style.display = 'block';
            gsap.to(appContainer, { opacity: 1, duration: 0.5 });
        } else {
            alert("LINK EXPIRED"); window.location.href = window.location.pathname; 
        }
    } catch(err) {
        console.error(err); window.location.href = window.location.pathname;
    }
}

function loadLocalData() {
    try { savedMovies = JSON.parse(localStorage.getItem("savedMovies")) || []; } catch(e) { savedMovies = []; }
}

function getOptimizedUrl(path, type = 'grid') {
    if(!path) return PLACEHOLDER;
    if(path.startsWith('http')) return path;
    if(type === 'search') return `${PROXY_BASE}w154${path}&output=webp&q=50`;
    return `${PROXY_BASE}w500${path}&output=webp&q=80`;
}

function buildRing() {
    const ringWrap = document.getElementById('ring-wrap');
    const inspector = document.getElementById('inspector');
    ringWrap.innerHTML = "";
    
    let postersToDisplay = [];
    if (savedMovies.length > 0) {
        const reversed = [...savedMovies].reverse();
        const slice = reversed.slice(0, 12);
        postersToDisplay = slice.map(m => {
            if(m.Poster && m.Poster.startsWith('/')) return getOptimizedUrl(m.Poster, 'grid');
            return m.Poster || PLACEHOLDER;
        });
    } else {
        const fallbacks = ["DUNE", "MATRIX", "BLADE RUNNER", "AKIRA", "INTERSTELLAR", "INCEPTION", "ARRIVAL", "TENET"];
        postersToDisplay = fallbacks.map(title => `https://via.placeholder.com/300x450/000000/FFFFFF?text=${encodeURIComponent(title)}`);
    }

    let loaded = 0;
    const total = postersToDisplay.length;
    if(total === 0) finishLoading();

    postersToDisplay.forEach(url => {
        const img = new Image();
        img.onload = img.onerror = () => {
            loaded++;
            const bar = document.getElementById('progress-bar');
            if(bar) bar.style.width = (loaded / total) * 100 + "%";
            if(loaded === total) finishLoading();
        };
        img.src = url;
    });

    function finishLoading() {
        gsap.to(loader, { opacity: 0, duration: 0.3, onComplete: () => loader.style.display = 'none' });
        gsap.to(introOverlay, { opacity: 1, duration: 0.5 });
        initRingAnimation(postersToDisplay);
    }

    function initRingAnimation(urls) {
        const radius = 280; let rotation = 0; const speed = 0.0005;
        const elements = urls.map((url, index) => {
            const el = document.createElement('div');
            el.className = 'ring-item';
            el.style.backgroundImage = `url(${url})`;
            el.onmouseenter = () => {
                ringWrap.classList.add('dimmed');
                inspector.style.backgroundImage = `url(${url})`;
                inspector.style.display = 'block';
                const rect = el.getBoundingClientRect();
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                gsap.set(inspector, { x: (rect.left + rect.width/2) - centerX, y: (rect.top + rect.height/2) - centerY, scale: 1, opacity: 1 });
                gsap.to(inspector, { x: 350, y: 0, scale: 2.5, duration: 0.4, ease: "power2.out" });
            };
            ringWrap.appendChild(el);
            return el;
        });
        inspector.onmouseleave = () => {
            gsap.to(inspector, { x: 100, scale: 0.8, opacity: 0, duration: 0.3, onComplete: () => {
                inspector.style.display = 'none'; ringWrap.classList.remove('dimmed');
            }});
        };
        function loop() {
            if(!ringActive) return;
            rotation += speed;
            elements.forEach((el, index) => {
                const angle = rotation + ((index / elements.length) * Math.PI * 2);
                el.style.transform = `translate3d(${Math.cos(angle) * radius}px, ${Math.sin(angle) * radius}px, 0)`;
            });
            requestAnimationFrame(loop);
        }
        ringActive = true; loop();
    }
}

window.triggerEntry = () => {
    ringActive = false; render(); 
    gsap.to('#ring-wrap', { scale: 3, opacity: 0, duration: 0.6, ease: "power2.in" });
    gsap.to('#inspector', { scale: 3, opacity: 0, duration: 0.6 }); 
    gsap.to('.center-title', { scale: 0.5, opacity: 0, duration: 0.4 });
    gsap.to(introOverlay, { opacity: 0, delay: 0.4, duration: 0.8, onComplete: () => { introOverlay.style.display = 'none'; } });
    appContainer.style.display = 'block';
    gsap.to(appContainer, { opacity: 1, delay: 0.4, duration: 0.8 });
    document.body.style.overflow = 'auto';
};

window.triggerReturn = () => {
    if(isSharedMode) { window.location.href = window.location.pathname; return; }
    gsap.to(appContainer, { opacity: 0, duration: 0.4, onComplete: () => {
        appContainer.style.display = 'none'; document.body.style.overflow = 'hidden';
        buildRing(); 
        introOverlay.style.display = 'block'; gsap.to(introOverlay, { opacity: 1, duration: 0.4 });
        gsap.to('#ring-wrap', { scale: 1, opacity: 1, duration: 0.4 });
        gsap.to('.center-title', { scale: 1, opacity: 1, duration: 0.4 });
    }});
};

function render() {
    mainGrid.innerHTML = "";
    if (savedMovies.length === 0) { emptyState.style.display = 'flex'; return; }
    emptyState.style.display = 'none';
    
    savedMovies.forEach((movie, index) => {
        const card = document.createElement('div'); card.className = 'card';
        let imgUrl = movie.Poster;
        if(movie.Poster && movie.Poster.startsWith('/')) {
            imgUrl = getOptimizedUrl(movie.Poster, 'grid');
        }
        
        let favHTML = '';
        if(movie.isFavorite) {
            favHTML = `<div class="fav-marker">♥</div>`;
        }
        if(selectedIDs.has(movie.imdbID)) {
            card.classList.add('selected');
        }

        card.innerHTML = `${favHTML}<img class="card-img" src="${imgUrl}" loading="lazy" decoding="async"><div class="card-overlay"><div class="card-title">${movie.Title}</div><div class="card-year">${movie.Year}</div></div>`;
        
        if(!isSharedMode) {
            card.ondblclick = (e) => {
                e.preventDefault();
                toggleSelection(movie.imdbID, card);
            };
        }
        
        mainGrid.appendChild(card);
        gsap.from(card, { y: 30, opacity: 0, duration: 0.6, delay: index * 0.05 });
    });
    
    updateSelectionUI();
}

function toggleSelection(id, cardElement) {
    if(selectedIDs.has(id)) {
        selectedIDs.delete(id);
        cardElement.classList.remove('selected');
    } else {
        selectedIDs.add(id);
        cardElement.classList.add('selected');
    }
    updateSelectionUI();
}

function updateSelectionUI() {
    if(selectedIDs.size > 0) {
        if(btnFav) btnFav.classList.add('visible');
        if(btnDel) btnDel.classList.add('visible');
    } else {
        if(btnFav) btnFav.classList.remove('visible');
        if(btnDel) btnDel.classList.remove('visible');
    }
}

let debounceTimer; 
async function performSearch() {
    const query = searchInput.value.trim();
    if (query.length < 1) { searchResults.innerHTML = ""; return; }
    searchResults.innerHTML = `<div style="color:#666; font-family:'Syncopate'">SCANNING...</div>`;
    
    try {
        let url;
        const isImdbId = /^tt\d+$/.test(query);

        if (isImdbId) {
            url = `https://api.themoviedb.org/3/find/${query}?api_key=${TMDB_KEY}&external_source=imdb_id`;
        } else {
            url = `https://api.themoviedb.org/3/search/multi?api_key=${TMDB_KEY}&query=${encodeURIComponent(query)}&include_adult=true`;
        }

        let res = await fetch(url);
        let data = await res.json();
        
        searchResults.innerHTML = "";
        
        let results = isImdbId ? [...(data.movie_results || []), ...(data.tv_results || [])] : data.results;

        if (results && results.length > 0) {
            results.forEach(m => {
                if(m.media_type === 'person') return;
                if(!m.poster_path) return;

                const el = document.createElement('div'); el.className = 'card'; el.style.border = "1px solid #333";
                
                let lowResUrl = `${PROXY_BASE}w154${m.poster_path}&output=webp&q=50`; 
                let highResUrl = `${PROXY_BASE}w342${m.poster_path}&output=webp&q=80`;
                
                let title = m.title || m.name; 
                let date = m.release_date || m.first_air_date;
                let startYear = date ? date.split('-')[0] : "N/A";
                
                let yearDisplayId = `year-${m.id}`;
                let yearText = startYear;

                if(m.media_type === 'tv' && startYear !== "N/A") {
                    yearText = `${startYear}-`; 
                    fetchTVStatus(m.id, yearDisplayId, startYear);
                }

                el.innerHTML = `<img class="card-img" src="${lowResUrl}" loading="lazy" decoding="async" style="filter:none;"><div class="card-overlay"><div class="card-title">${title}</div><div class="card-year" id="${yearDisplayId}">${yearText}</div></div>`;
                
                el.onmouseenter = function() {
                    const img = this.querySelector('img');
                    if(img.src !== highResUrl) img.src = highResUrl;
                };

                const movieObj = {
                    Title: title,
                    Year: yearText, 
                    Poster: m.poster_path, 
                    imdbID: m.id.toString(),
                    isFavorite: false 
                };
                
                el.onclick = function() {
                    const currentYearText = document.getElementById(yearDisplayId).innerText;
                    movieObj.Year = currentYearText;
                    addToLibrary(movieObj);
                }; 
                
                searchResults.appendChild(el);
            });
        } else { 
            searchResults.innerHTML = `<div style="color:#666">NO DATA FOUND</div>`; 
        }
    } catch(err) { 
        console.error(err);
        searchResults.innerHTML = `<div style="color:red">CONNECTION ERROR</div>`; 
    }
}

async function fetchTVStatus(id, elementId, startYear) {
    try {
        let res = await fetch(`https://api.themoviedb.org/3/tv/${id}?api_key=${TMDB_KEY}`);
        let data = await res.json();
        const el = document.getElementById(elementId);
        if(el) {
            if(data.status === "Ended" || data.status === "Canceled") {
                let endYear = data.last_air_date ? data.last_air_date.split('-')[0] : "";
                if(endYear && endYear !== startYear) {
                    el.innerText = `${startYear}-${endYear}`;
                } else {
                    el.innerText = startYear;
                }
            } else {
                el.innerText = `${startYear}-`;
            }
        }
    } catch(e) { }
}

function addToLibrary(movie) { 
    if (savedMovies.find(m => m.imdbID === movie.imdbID)) return showToast("ALREADY SAVED"); 
    savedMovies.push(movie); 
    localStorage.setItem("savedMovies", JSON.stringify(savedMovies)); 
    showToast(`SAVED: ${movie.Title}`); 
    render(); 
}

function removeMovie(id) { 
    savedMovies = savedMovies.filter(m => m.imdbID !== id); 
    localStorage.setItem("savedMovies", JSON.stringify(savedMovies)); 
    render(); showToast("DELETED"); 
}

const btnShare = document.getElementById('btn-share');
if(btnShare) {
    btnShare.onclick = async () => {
        if(isSharedMode) { copyToClipboard(window.location.href); return; }
        if(savedMovies.length === 0) return showToast("EMPTY DATABASE");
        const originalText = btnShare.innerHTML; btnShare.innerHTML = `<span>GENERATING...</span>`;
        try {
            if(!window.db) throw new Error("DB NOT READY");
            const shareId = Math.random().toString(36).substring(2, 9);
            await window.db.collection("shares").doc(shareId).set({ movies: savedMovies, createdAt: Date.now() });
            const link = `${window.location.origin}${window.location.pathname}?view=${shareId}`;
            copyToClipboard(link);
        } catch(err) { console.error(err); showToast("ERROR"); } finally { setTimeout(() => btnShare.innerHTML = originalText, 2000); }
    };
}

const btnImport = document.getElementById('btn-import');
if(btnImport) {
    btnImport.onclick = () => {
        if(confirm("MERGE INTO YOUR ARCHIVE?")) {
            let current = []; try { current = JSON.parse(localStorage.getItem("savedMovies")) || []; } catch(e){}
            const merged = [...current, ...savedMovies].filter((obj, index, self) => index === self.findIndex((t) => t.imdbID === obj.imdbID));
            localStorage.setItem("savedMovies", JSON.stringify(merged)); 
            window.location.href = window.location.pathname; 
        }
    };
}

function showToast(msg) { 
    clearTimeout(toastTimer); // Prevent stacking
    toast.innerText = msg; 
    toast.style.transform = "translateX(0)"; // SHOW
    
    // Wait 1.5s then slide out
    toastTimer = setTimeout(() => { 
        toast.style.transform = "translateX(120%)"; // HIDE COMPLETELY
    }, 1500); 
}

function copyToClipboard(text) { if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(text).then(() => showToast("LINK COPIED")); } else { prompt("COPY LINK:", text); } }
</script>
</body>
</html>
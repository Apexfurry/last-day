<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LAST DAY // FINAL SYSTEM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;800&family=Syncopate:wght@700;800&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<style>
/* --- CORE VARIABLES --- */
:root {
    --bg: #030303;
    --primary: #00ff41;
    --accent: #ff0055;
    --text: #ffffff;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', sans-serif;
    overflow: hidden; 
    height: 100vh;
}

/* =========================
   LOADER
   ========================= */
#loader {
    position: fixed; inset: 0; z-index: 10000;
    background: #000;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    transition: opacity 0.5s;
    pointer-events: none;
}
.loader-text {
    font-family: 'Syncopate', sans-serif; color: var(--primary);
    font-size: 1.5rem; letter-spacing: 5px; margin-bottom: 20px;
    text-transform: uppercase;
}
.loader-bar {
    width: 200px; height: 2px; background: #333; position: relative; overflow: hidden;
}
.loader-progress {
    position: absolute; top: 0; left: 0; height: 100%; width: 0%;
    background: var(--primary); transition: width 0.2s;
}

/* =========================
   PAGE 1: THE RING INTRO
   ========================= */
#intro-overlay {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: 9999; background: #000; overflow: hidden;
    opacity: 0; transition: opacity 1s;
    perspective: 1200px; /* Deep 3D Space */
}

#canvas-container {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 1; transition: opacity 0.6s;
}

/* CENTER TEXT */
.center-title {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    z-index: 50;
    font-family: 'Syncopate', sans-serif; font-weight: 700; font-size: 0.9rem;
    letter-spacing: 4px; color: #fff; cursor: pointer; text-transform: uppercase;
    transition: all 0.4s; pointer-events: auto;
    text-shadow: 0 0 20px rgba(255,255,255,0.2);
    padding: 40px; /* Large hit area */
}
.center-title:hover {
    color: var(--primary); text-shadow: 0 0 40px var(--primary); letter-spacing: 6px;
}

/* RING CONTAINER */
#ring-wrap {
    position: absolute; top: 50%; left: 50%; width: 0; height: 0; z-index: 100;
}

/* RING ITEMS */
.ring-item {
    position: absolute; top: -90px; left: -60px;
    width: 120px; height: 180px;
    background-size: cover; background-position: center;
    border: 1px solid rgba(255,255,255,0.15);
    cursor: default;
    
    /* PERFORMANCE OPTIMIZATION */
    will-change: transform, opacity; 
    backface-visibility: hidden; 
    transform: translateZ(0); 
    
    transition: opacity 0.3s, filter 0.3s;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

#ring-wrap.dimmed .ring-item {
    opacity: 0.2; filter: grayscale(100%) blur(2px); pointer-events: none; 
}

/* THE "GHOST" INSPECTOR */
#inspector {
    position: absolute; top: 50%; left: 50%;
    width: 120px; height: 180px; 
    
    background-size: cover; background-position: center;
    
    /* Sharpness & Speed */
    image-rendering: -webkit-optimize-contrast; 
    will-change: transform;
    backface-visibility: hidden;
    transform: translateZ(0);

    z-index: 1000; display: none; pointer-events: auto; cursor: default;
    border: 1px solid #fff; box-shadow: 0 30px 80px rgba(0,0,0,0.9);
}


/* =========================
   PAGE 2: THE APP
   ========================= */
#app-container {
    display: none; opacity: 0; height: 100vh; overflow-y: auto;
    position: relative; z-index: 50;
    background: radial-gradient(circle at 50% 50%, #111 0%, #000 100%);
}
.bg-grid {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px; pointer-events: none; z-index: -1;
}
header {
    position: fixed; top: 0; left: 0; right: 0; height: 80px;
    background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255,255,255,0.1); 
    display: flex; align-items: center; justify-content: space-between; 
    padding: 0 40px; z-index: 100;
}
#return-btn {
    font-family: 'Syncopate', sans-serif; font-weight: 700; font-size: 0.9rem; color: #888; 
    cursor: pointer; text-transform: uppercase; transition: color 0.3s, transform 0.3s; 
    display: flex; align-items: center; gap: 10px;
}
#return-btn::before { content: '←'; font-family: 'Inter'; font-size: 1.2rem; }
#return-btn:hover { color: #fff; transform: translateX(-5px); }

#header-search-btn {
    background: #fff; color: #000; border: none; padding: 12px 24px;
    font-family: 'Inter', sans-serif; font-weight: 800; font-size: 0.8rem;
    cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
    transition: transform 0.2s, background 0.2s;
}
#header-search-btn:hover { transform: scale(1.05); background: var(--primary); }

#main-grid { margin-top: 100px; padding: 0 40px 40px 40px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 30px; }
.card { position: relative; aspect-ratio: 2/3; background: #1a1a1a; cursor: pointer; transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); overflow: hidden; border: 1px solid transparent; }
.card-img { width: 100%; height: 100%; object-fit: cover; filter: grayscale(100%) contrast(1.2); transition: filter 0.4s; }
.card:hover { transform: translateY(-10px) scale(1.02); z-index: 10; border-color: var(--primary); box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
.card:hover .card-img { filter: grayscale(0%) contrast(1); }
.card-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); padding: 20px; transform: translateY(100%); transition: transform 0.3s; }
.card:hover .card-overlay { transform: translateY(0); }
.card-title { font-family: 'Inter', sans-serif; font-weight: 700; font-size: 0.9rem; color: #fff; margin-bottom: 4px; }
.card-year { font-size: 0.75rem; color: var(--primary); font-family: 'Syncopate'; }

.controls { position: fixed; bottom: 40px; right: 40px; display: flex; flex-direction: column; gap: 12px; z-index: 200; }
.btn { background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); color: var(--text); border: 1px solid rgba(255,255,255,0.2); padding: 14px 24px; font-family: 'Inter', sans-serif; font-size: 0.8rem; font-weight: 600; cursor: pointer; text-transform: uppercase; transition: all 0.2s; display: flex; align-items: center; justify-content: space-between; gap: 20px; min-width: 160px; }
.btn:hover { background: #fff; color: #000; border-color: #fff; }

#search-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.92); backdrop-filter: blur(10px); z-index: 300; display: none; flex-direction: column; padding: 120px 10vw; }
.search-bar-wrap { border-bottom: 2px solid #333; display: flex; align-items: center; margin-bottom: 50px; }
#search-input { width: 100%; background: transparent; border: none; color: #fff; font-family: 'Syncopate', sans-serif; font-weight: 700; font-size: 4vw; outline: none; text-transform: uppercase; padding: 20px 0; }
#search-input::placeholder { color: #333; }
#close-search { position: absolute; top: 40px; right: 40px; font-size: 2rem; cursor: pointer; color: #555; transition: color 0.3s; }
#close-search:hover { color: #fff; }
#search-results { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 30px; overflow-y: auto; padding-bottom: 100px; }
#empty-state { position: fixed; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; opacity: 0.3; }
#empty-state h1 { font-family: 'Syncopate'; font-size: 4rem; letter-spacing: 10px; }
#toast { position: fixed; top: 100px; right: -300px; background: var(--primary); color: #000; padding: 15px 30px; font-family: 'Syncopate'; font-weight: 700; font-size: 0.8rem; z-index: 500; transition: right 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
</style>
</head>
<body>

<div id="loader">
    <div class="loader-text">SYSTEM BOOT</div>
    <div class="loader-bar"><div class="loader-progress" id="progress-bar"></div></div>
</div>

<div id="intro-overlay">
    <div id="canvas-container"></div>
    <div class="center-title" id="enter-trigger">LAST DAY</div>
    <div id="ring-wrap"></div>
    <div id="inspector"></div>
</div>

<div id="app-container">
    <div class="bg-grid"></div>
    <header>
        <div id="return-btn">RETURN</div>
        <button id="header-search-btn">SEARCH [S]</button>
    </header>
    <div id="main-grid"></div>
    <div id="empty-state"><h1>NULL</h1><p>NO RECORDS FOUND</p></div>
    <div class="controls">
        <button class="btn" id="btn-share"><span>Share</span> <span>☍</span></button>
        <button class="btn" id="btn-import" style="display:none; border-color: var(--accent); color: var(--accent);"><span>Import</span> <span>⇩</span></button>
    </div>
    <div id="search-overlay">
        <div id="close-search">✕</div>
        <div class="search-bar-wrap">
            <input type="text" id="search-input" placeholder="TYPE QUERY..." autocomplete="off">
        </div>
        <div id="search-results"></div>
    </div>
    <div id="toast">SUCCESS</div>
</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.126.0/build/three.module.js';
import { EffectComposer } from 'https://unpkg.com/three@0.126.0/examples/jsm/postprocessing/EffectComposer.js';
import { RenderPass } from 'https://unpkg.com/three@0.126.0/examples/jsm/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'https://unpkg.com/three@0.126.0/examples/jsm/postprocessing/UnrealBloomPass.js';

let camera, scene, renderer, composer, particles;
let mouseX = 0, mouseY = 0;

// DETECT LOW SPEC DEVICES (Mobiles or Small Screens)
const isLowSpec = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 900;

// CONFIGURE SETTINGS
const SETTINGS = {
    particleCount: isLowSpec ? 300 : 1500, // Reduce load on weak devices
    useBloom: !isLowSpec,                  // Disable heavy glow on weak devices
    pixelRatio: isLowSpec ? 1 : Math.min(window.devicePixelRatio, 2) // Cap resolution
};

function init() {
    const container = document.getElementById('canvas-container');
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 3000);
    camera.position.z = 1000;
    
    scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x000000, 0.001);

    const geometry = new THREE.TetrahedronGeometry(10, 0);
    const material = new THREE.MeshBasicMaterial({ color: 0x444444, wireframe: true });
    
    // Create Particles
    particles = new THREE.InstancedMesh(geometry, material, SETTINGS.particleCount);
    const dummy = new THREE.Object3D();
    
    for(let i = 0; i < SETTINGS.particleCount; i++) {
        dummy.position.set(Math.random()*2000-1000, Math.random()*2000-1000, Math.random()*2000-1000);
        dummy.rotation.set(Math.random()*Math.PI, Math.random()*Math.PI, 0);
        const scale = Math.random() * 2 + 0.5;
        dummy.scale.set(scale, scale, scale);
        dummy.updateMatrix();
        particles.setMatrixAt(i, dummy.matrix);
    }
    scene.add(particles);

    // Renderer Setup
    renderer = new THREE.WebGLRenderer({ 
        antialias: !isLowSpec, 
        powerPreference: "high-performance",
        alpha: false 
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(SETTINGS.pixelRatio);
    container.appendChild(renderer.domElement);

    // Bloom Setup (Only if high spec)
    if (SETTINGS.useBloom) {
        const renderScene = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.2, 0.4, 0.85);
        composer = new EffectComposer(renderer);
        composer.addPass(renderScene);
        composer.addPass(bloomPass);
    }

    document.addEventListener('mousemove', (e) => {
        mouseX = (e.clientX - window.innerWidth / 2) * 0.5;
        mouseY = (e.clientY - window.innerHeight / 2) * 0.5;
    });
    
    animate();
}

function animate() {
    if(!document.getElementById('intro-overlay').style.display === 'none') return;
    requestAnimationFrame(animate);
    
    camera.position.x += (mouseX - camera.position.x) * 0.05;
    camera.position.y += (-mouseY - camera.position.y) * 0.05;
    camera.lookAt(scene.position);
    particles.rotation.y += 0.001;

    if (SETTINGS.useBloom) {
        composer.render();
    } else {
        renderer.render(scene, camera);
    }
}

init();
</script>

<script>
let ringActive = true;

// Preload
function preloadImages(urls, callback) {
    let loaded = 0;
    const total = urls.length;
    const progressBar = document.getElementById('progress-bar');
    if(total === 0) { callback(); return; }
    urls.forEach(url => {
        const img = new Image();
        img.onload = img.onerror = () => {
            loaded++;
            progressBar.style.width = (loaded / total) * 100 + "%";
            if(loaded === total) callback();
        };
        img.src = url;
    });
}

function buildRing() {
    const ringWrap = document.getElementById('ring-wrap');
    const inspector = document.getElementById('inspector');
    ringWrap.innerHTML = "";
    
    let savedData = [];
    try { savedData = JSON.parse(localStorage.getItem("savedMovies")) || []; } catch(e) { savedData = []; }

    let postersToDisplay = [];
    
    // 1. DETERMINE URLS (Use standard res for speed)
    if (savedData.length > 0) {
        const reversed = [...savedData].reverse();
        const slice = reversed.slice(0, 12);
        postersToDisplay = slice.map(m => {
            return m.Poster && m.Poster !== "N/A" ? m.Poster : "https://via.placeholder.com/300x450/000000/FFFFFF?text=NO+IMG";
        });
    } else {
        const fallbacks = ["DUNE", "MATRIX", "BLADE RUNNER", "TRON", "AKIRA", "INTERSTELLAR", "ALIEN", "INCEPTION", "ARRIVAL", "EX MACHINA", "TENET", "ROBOCOP"];
        postersToDisplay = fallbacks.map(title => `https://via.placeholder.com/300x450/000000/FFFFFF?text=${encodeURIComponent(title)}`);
    }

    // 2. PRELOAD
    preloadImages(postersToDisplay, () => {
        const loader = document.getElementById('loader');
        loader.style.opacity = 0;
        setTimeout(() => loader.style.display = 'none', 500);
        document.getElementById('intro-overlay').style.opacity = 1;

        const radius = 280; 
        let rotation = 0;
        const speed = 0.002; 
        
        const elements = postersToDisplay.map((url, index) => {
            const el = document.createElement('div');
            el.className = 'ring-item';
            el.style.backgroundImage = `url(${url})`;
            
            // --- GHOST LOGIC (SHARPENING) ---
            el.onmouseenter = () => {
                ringWrap.classList.add('dimmed');
                const rect = el.getBoundingClientRect();
                
                // 1. Set Low Res First (Instant)
                inspector.style.backgroundImage = `url(${url})`;
                inspector.style.display = 'block';
                
                // 2. Load High Res in background silently
                if(url.includes("SX300")) {
                    let hiRes = url.replace("SX300", "SX700");
                    let img = new Image();
                    img.src = hiRes;
                    img.onload = () => {
                        if(inspector.style.display === 'block') {
                            inspector.style.backgroundImage = `url(${hiRes})`;
                        }
                    };
                }
                
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                const itemX = rect.left + rect.width/2;
                const itemY = rect.top + rect.height/2;
                
                gsap.set(inspector, { x: itemX - centerX, y: itemY - centerY, scale: 1, opacity: 1 });
                gsap.to(inspector, { x: 350, y: 0, scale: 2.5, duration: 0.5, ease: "expo.out", force3D: true });
            };
            
            ringWrap.appendChild(el);
            return el;
        });

        // --- RETURN LOGIC ---
        inspector.onmouseleave = () => {
            // Fly back towards circle
            gsap.to(inspector, {
                x: 100, scale: 0.8, opacity: 0, duration: 0.4, ease: "power2.in", force3D: true,
                onComplete: () => {
                    inspector.style.display = 'none';
                    ringWrap.classList.remove('dimmed');
                }
            });
        };
        
        // --- LOOP ---
        function loop() {
            if(!ringActive) return;
            rotation += speed;
            elements.forEach((el, index) => {
                const offset = (index / elements.length) * Math.PI * 2;
                const angle = rotation + offset;
                // Force GPU
                el.style.transform = `translate3d(${Math.cos(angle) * radius}px, ${Math.sin(angle) * radius}px, 0)`;
            });
            requestAnimationFrame(loop);
        }
        ringActive = true;
        loop();
    });
}
buildRing();


// --- TRANSITIONS ---
window.triggerEntry = () => {
    ringActive = false;
    gsap.to('#ring-wrap', { scale: 3, opacity: 0, duration: 0.8, ease: "power2.in" });
    gsap.to('#inspector', { scale: 3, opacity: 0, duration: 0.8 }); 
    gsap.to('.center-title', { scale: 0.5, opacity: 0, duration: 0.5 });
    
    gsap.to('#intro-overlay', {
        opacity: 0, delay: 0.5, duration: 1,
        onComplete: () => { document.getElementById('intro-overlay').style.display = 'none'; }
    });

    const app = document.getElementById('app-container');
    app.style.display = 'block';
    gsap.to(app, { opacity: 1, delay: 0.5, duration: 1 });
    document.body.style.overflow = 'auto';

    if(window.appNotInitialized) window.initAppLogic();
};

window.triggerReturn = () => {
    const app = document.getElementById('app-container');
    gsap.to(app, { opacity: 0, duration: 0.5, onComplete: () => {
        app.style.display = 'none';
        document.body.style.overflow = 'hidden';
        
        buildRing(); 

        const intro = document.getElementById('intro-overlay');
        intro.style.display = 'block';
        gsap.to(intro, { opacity: 1, duration: 0.5 });
        
        gsap.to('#ring-wrap', { scale: 1, opacity: 1, duration: 0.5 });
        gsap.to('.center-title', { scale: 1, opacity: 1, duration: 0.5 });
    }});
};

// Only center text triggers entry
document.getElementById('enter-trigger').onclick = window.triggerEntry;
document.getElementById('return-btn').onclick = window.triggerReturn;


// --- APP LOGIC ---
const OMDB_KEY = "a274b977"; 
const PLACEHOLDER = "https://via.placeholder.com/300x450/111/333?text=NO+IMG";
window.appNotInitialized = true; 

const firebaseConfig = {
    apiKey: "AIzaSyCt6s0fVkb7DtQeq9H05wg_D0Lw_S10-0",
    authDomain: "lastday-18.firebaseapp.com",
    projectId: "lastday-18",
    storageBucket: "lastday-18.firebasestorage.app",
    messagingSenderId: "413600100426",
    appId: "1:413600100426:web:c55e5c7fd46028a26236b3"
};
try { firebase.initializeApp(firebaseConfig); window.db = firebase.firestore(); } catch (e) { console.error(e); }

let savedMovies = [];
let isSharedMode = false;
const mainGrid = document.getElementById('main-grid');
const emptyState = document.getElementById('empty-state');
const searchOverlay = document.getElementById('search-overlay');
const searchInput = document.getElementById('search-input');
const searchResults = document.getElementById('search-results');
const toast = document.getElementById('toast');

window.onload = () => {
    const params = new URLSearchParams(location.search);
    if (params.get("view")) {
        // Hide loader & intro immediately for shared views
        document.getElementById('loader').style.display = 'none';
        document.getElementById('intro-overlay').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        document.body.style.overflow = 'auto';
        window.initAppLogic();
    }
};

window.initAppLogic = async () => {
    window.appNotInitialized = false;
    const params = new URLSearchParams(location.search);
    const viewId = params.get("view");
    const sessionData = sessionStorage.getItem("sharedMovies");

    if (viewId) {
        enableSharedMode();
        showToast("DOWNLOADING ARCHIVE...");
        await loadSharedData(viewId);
    } else if (sessionData) {
        enableSharedMode();
        savedMovies = JSON.parse(sessionData);
        window.history.replaceState({}, document.title, window.location.pathname);
        render();
    } else {
        loadLocalData();
        render();
    }
}

function loadLocalData() { try { savedMovies = JSON.parse(localStorage.getItem("savedMovies")) || []; } catch(e) { savedMovies = []; } }

function enableSharedMode() {
    isSharedMode = true;
    savedMovies = [];
    document.getElementById('btn-import').style.display = 'flex';
    document.getElementById('btn-share').innerHTML = `<span>COPY LINK</span> <span>©</span>`;
}

function render() {
    mainGrid.innerHTML = "";
    if (savedMovies.length === 0) { emptyState.style.display = 'flex'; return; }
    emptyState.style.display = 'none';
    savedMovies.forEach((movie, index) => {
        const card = document.createElement('div'); card.className = 'card';
        let imgUrl = movie.Poster && movie.Poster !== "N/A" ? movie.Poster : PLACEHOLDER;
        if(imgUrl.includes("SX300")) imgUrl = imgUrl.replace("SX300", "SX700");
        card.innerHTML = `<img class="card-img" src="${imgUrl}" loading="lazy"><div class="card-overlay"><div class="card-title">${movie.Title}</div><div class="card-year">${movie.Year}</div></div>`;
        if(!isSharedMode) { card.oncontextmenu = (e) => { e.preventDefault(); if(confirm(`DELETE "${movie.Title}"?`)) removeMovie(movie.imdbID); }; }
        mainGrid.appendChild(card);
        gsap.from(card, { y: 30, opacity: 0, duration: 0.6, delay: index * 0.05 });
    });
}

document.getElementById('header-search-btn').onclick = () => { 
    if(isSharedMode) return showToast("LOCKED: READ ONLY"); 
    searchOverlay.style.display = 'flex'; searchInput.focus(); 
};
document.getElementById('close-search').onclick = () => { searchOverlay.style.display = 'none'; };
document.addEventListener('keydown', (e) => { 
    if (e.key === 'Escape') searchOverlay.style.display = 'none'; 
    if (e.key === 's' && document.activeElement !== searchInput && !isSharedMode) { e.preventDefault(); searchOverlay.style.display = 'flex'; searchInput.focus(); }
});
let debounceTimer; searchInput.oninput = () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(performSearch, 500); };

async function performSearch() {
    const query = searchInput.value.trim();
    if (query.length < 1) { searchResults.innerHTML = ""; return; }
    searchResults.innerHTML = `<div style="color:#666; font-family:'Syncopate'">SCANNING...</div>`;
    try {
        let url = `https://www.omdbapi.com/?apikey=${OMDB_KEY}&s=${encodeURIComponent(query)}`;
        let res = await fetch(url); let data = await res.json();
        if (data.Response === "False") {
            const exactUrl = `https://www.omdbapi.com/?apikey=${OMDB_KEY}&t=${encodeURIComponent(query)}`;
            const res2 = await fetch(exactUrl); const data2 = await res2.json();
            if (data2.Response === "True") data = { Response: "True", Search: [data2] };
        }
        searchResults.innerHTML = "";
        if (data.Response === "True" && data.Search) {
            data.Search.forEach(m => {
                const el = document.createElement('div'); el.className = 'card'; el.style.border = "1px solid #333";
                let imgUrl = m.Poster !== "N/A" ? m.Poster : PLACEHOLDER;
                el.innerHTML = `<img class="card-img" src="${imgUrl}" style="filter:none;"><div class="card-overlay" style="transform:translateY(0)"><div class="card-title">ADD TO ARCHIVE +</div></div>`;
                el.onclick = () => addToLibrary(m); searchResults.appendChild(el);
            });
        } else { searchResults.innerHTML = `<div style="color:#666">NO DATA FOUND</div>`; }
    } catch(err) { searchResults.innerHTML = `<div style="color:red">CONNECTION ERROR</div>`; }
}
function addToLibrary(movie) { if (savedMovies.find(m => m.imdbID === movie.imdbID)) return showToast("ALREADY SAVED"); savedMovies.push(movie); localStorage.setItem("savedMovies", JSON.stringify(savedMovies)); showToast(`SAVED: ${movie.Title}`); render(); }
function removeMovie(id) { savedMovies = savedMovies.filter(m => m.imdbID !== id); localStorage.setItem("savedMovies", JSON.stringify(savedMovies)); render(); showToast("DELETED"); }

const btnShare = document.getElementById('btn-share');
btnShare.onclick = async () => {
    if(isSharedMode) { copyToClipboard(window.location.href); return; }
    if(savedMovies.length === 0) return showToast("EMPTY DATABASE");
    const originalText = btnShare.innerHTML; btnShare.innerHTML = `<span>GENERATING...</span>`;
    try {
        if(!window.db) throw new Error("DB NOT READY");
        const shareId = Math.random().toString(36).substring(2, 9);
        await window.db.collection("shares").doc(shareId).set({ movies: savedMovies, createdAt: Date.now() });
        copyToClipboard(`${window.location.origin}${window.location.pathname}?view=${shareId}`);
    } catch(err) { console.error(err); showToast("ERROR"); } finally { setTimeout(() => btnShare.innerHTML = originalText, 2000); }
};
async function loadSharedData(id) {
    if(!window.db) { setTimeout(()=>loadSharedData(id), 500); return; }
    try { const doc = await window.db.collection("shares").doc(id).get();
        if (doc.exists) { savedMovies = doc.data().movies; sessionStorage.setItem("sharedMovies", JSON.stringify(savedMovies)); window.location.href = window.location.pathname; } else { alert("LINK EXPIRED"); window.location.href = window.location.pathname; }
    } catch(err) { alert("NETWORK ERROR"); }
}
document.getElementById('btn-import').onclick = () => {
    if(confirm("MERGE INTO YOUR ARCHIVE?")) {
        let current = []; try { current = JSON.parse(localStorage.getItem("savedMovies")) || []; } catch(e){}
        const merged = [...current, ...savedMovies].filter((obj, index, self) => index === self.findIndex((t) => t.imdbID === obj.imdbID));
        localStorage.setItem("savedMovies", JSON.stringify(merged)); sessionStorage.removeItem("sharedMovies"); window.location.href = window.location.pathname;
    }
};
function showToast(msg) { toast.innerText = msg; toast.style.right = "30px"; setTimeout(() => { toast.style.right = "-300px"; }, 3000); }
function copyToClipboard(text) { if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(text).then(() => showToast("LINK COPIED")); } else { prompt("COPY LINK:", text); } }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LAST DAY</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}

body{
  background:#000;
  color:#fff;
  font-family:'Inter',sans-serif;
  width:100vw;
  height:100vh;
  overflow:hidden;
  display:flex;
  justify-content:center;
  align-items:center;
  transition: border 0.3s;
}

/* SHARED MODE BORDER */
body.is-shared {
    border: 6px solid #ff0044;
}

#trigger{
  font-family:'Bebas Neue';
  letter-spacing:.45em;
  font-size:1.2rem;
  cursor:pointer;
  z-index:9999;
  padding:20px;
  user-select:none;
}

/* Change Title Color in Shared Mode */
body.is-shared #trigger { color: #ff0044; }

#circle{
  position:fixed;
  inset:0;
  display:flex;
  justify-content:center;
  align-items:center;
  pointer-events:none;
  z-index:1;
}

.poster{
  position:absolute;
  width:140px;
  height:210px;
  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;
  box-shadow:0 40px 120px rgba(0,0,0,.95);
  opacity:0;
  pointer-events:auto;
  backface-visibility:hidden;
  transform:translateZ(0);
  will-change:transform,opacity;
}

.poster::after{
  content:"";
  position:absolute;
  inset:0;
  background-image:radial-gradient(rgba(255,255,255,.03) 1px, transparent 1px);
  background-size:2px 2px;
  pointer-events:none;
  opacity:.15;
}

#archive{
  position:fixed;
  inset:0;
  padding:10vh 5vw;
  display:none;
  overflow-y:auto;
  z-index:50;
}

#search-wrap{
  position:fixed;
  top:24px;
  right:24px;
  z-index:300;
  display:flex;
  align-items:center;
  gap:12px;
}

#search-icon{
  font-size:1.2rem;
  cursor:pointer;
  opacity:.8;
}

#search-bar{
  width:0;
  overflow:hidden;
  opacity:0;
  transition:width .4s ease, opacity .3s ease;
}

#search-bar.active{
  width:220px;
  opacity:1;
}

#search-input{
  width:100%;
  background:transparent;
  border:none;
  border-bottom:1px solid #333;
  color:#fff;
  font-size:.95rem;
  outline:none;
  padding:4px 0;
}

#search-results{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
  gap:20px;
  margin-top:60px;
}

.grid{
  margin-top:100px;
  max-width:1600px;
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:4vw;
}

.grid-item{
  aspect-ratio:2/3;
  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;
  cursor:pointer;
  backface-visibility:hidden;
  transform:translateZ(0);
  will-change:transform,opacity;
}

/* SHARED BANNER */
#shared-banner{
    position: fixed;
    bottom: 24px;
    left: 24px;
    display: none; 
    z-index: 300;
    align-items: center;
    gap: 15px;
    background: rgba(0,0,0,0.9);
    padding: 12px 24px;
    border: 1px solid #333;
}

#shared-text {
    font-family: 'Bebas Neue';
    letter-spacing: .1em;
    color: #ff0044;
    font-size: 1.1rem;
}

#exit-btn {
    font-family: 'Inter';
    font-size: 0.8rem;
    color: #fff;
    border: 1px solid #555;
    padding: 6px 14px;
    cursor: pointer;
    text-transform: uppercase;
    background: #111;
}
#exit-btn:hover { background: #fff; color: #000; }

#controls{
  position:fixed;
  bottom:24px;
  right:24px;
  z-index:300;
  display:flex;
  gap:25px;
}

.control-btn{
  font-family:'Bebas Neue';
  letter-spacing:.2em;
  cursor:pointer;
  opacity:0.6;
  transition:opacity 0.3s;
  font-size: 1rem;
}
.control-btn:hover{opacity:1;}

#return{
  position:fixed;
  top:30px;
  left:30px;
  font-family:'Bebas Neue';
  letter-spacing:.3em;
  cursor:pointer;
  opacity:0;
  pointer-events:none;
  z-index:200;
}
</style>
</head>

<body>

<audio id="hoverSound" src="assets/audio/og.mp3"></audio>

<div id="trigger">LAST DAY</div>
<div id="circle"></div>

<div id="archive">
  <div id="search-wrap">
    <div id="search-icon">üîç</div>
    <div id="search-bar">
      <input id="search-input" placeholder="Search movie or series..." />
    </div>
  </div>
  <div id="search-results"></div>
  <div class="grid" id="grid"></div>
</div>

<div id="shared-banner">
    <span id="shared-text">VIEWING SHARED LIST</span>
    <span id="exit-btn">EXIT TO MY LIST</span>
</div>

<div id="controls">
  <div class="control-btn" id="import-btn" style="display:none">IMPORT</div>
  <div class="control-btn" id="share-btn">SHARE</div>
</div>

<div id="return">RETURN</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCt6s0fVkb7DtQeq9H05wg_D0Lw_S10-0",
    authDomain: "lastday-18.firebaseapp.com",
    projectId: "lastday-18",
    storageBucket: "lastday-18.firebasestorage.app",
    messagingSenderId: "413600100426",
    appId: "1:413600100426:web:c55e5c7fd46028a26236b3"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.db = db;
  window.doc = doc;
  window.setDoc = setDoc;
  window.getDoc = getDoc;

  if(window.initApp) window.initApp();
</script>

<script>
/* ---------- MAIN LOGIC ---------- */
const OMDB_KEY="a274b977";
const FALLBACK="https://via.placeholder.com/500x750/000000/FFFFFF?text=NO+POSTER";
const hiRes=u=>u&&u!=="N/A"?u.replace("_SX300","_SX700"):FALLBACK;

// DOM Elements
const trigger = document.getElementById("trigger");
const circle = document.getElementById("circle");
const archive = document.getElementById("archive");
const grid = document.getElementById("grid");
const ret = document.getElementById("return");
const searchIcon = document.getElementById("search-icon");
const searchBar = document.getElementById("search-bar");
const searchInput = document.getElementById("search-input");
const searchResults = document.getElementById("search-results");
const sharedBanner = document.getElementById("shared-banner");
const exitBtn = document.getElementById("exit-btn");
const importBtn = document.getElementById("import-btn");
const shareBtn = document.getElementById("share-btn");
const hoverSound = document.getElementById("hoverSound");

// Global State
let state = 0; 
let savedMovies = []; 
let circleItems = []; // Needed for effect
let isSharedMode = false; 

/* ---------- INITIALIZATION ---------- */
window.initApp = async () => {
    
    const params = new URLSearchParams(location.search);
    const viewId = params.get("view");
    const sessionData = sessionStorage.getItem("sharedMovies");

    if (viewId) {
        console.log("Link detected. Fetching...");
        enterSharedMode(); 
        await loadFromFirebase(viewId);
    } 
    else if (sessionData) {
        console.log("Session data found.");
        enterSharedMode();
        savedMovies = JSON.parse(sessionData);
        window.history.replaceState({}, document.title, window.location.pathname);
    } 
    else {
        loadLocalData();
    }
};

function loadLocalData() {
    isSharedMode = false;
    document.body.classList.remove("is-shared");
    sharedBanner.style.display = "none";
    trigger.innerText = "LAST DAY";
    searchIcon.style.display = "block"; 
    importBtn.style.display = "none";
    shareBtn.innerText = "SHARE";
    
    try {
        savedMovies = JSON.parse(localStorage.getItem("savedMovies")) || [];
    } catch(e) { savedMovies = []; }
}

function enterSharedMode() {
    isSharedMode = true;
    savedMovies = []; 
    document.body.classList.add("is-shared");
    sharedBanner.style.display = "flex";
    trigger.innerText = "SHARED LIST";
    searchIcon.style.display = "none"; 
    importBtn.style.display = "block"; 
    shareBtn.innerText = "COPY LINK"; 
}

async function loadFromFirebase(id) {
    if(!window.db) return setTimeout(()=>loadFromFirebase(id), 500);

    try {
        const snap = await window.getDoc(window.doc(window.db, "shares", id));
        if(snap.exists()) {
            const data = snap.data();
            savedMovies = data.movies;
            sessionStorage.setItem("sharedMovies", JSON.stringify(savedMovies));
            window.history.replaceState({}, document.title, window.location.pathname);
        } else {
            alert("Link expired or invalid.");
            exitSharedMode();
        }
    } catch(e) {
        alert("Error loading shared list.");
    }
}

exitBtn.onclick = exitSharedMode;

function exitSharedMode() {
    sessionStorage.removeItem("sharedMovies"); 
    window.location.href = window.location.pathname; 
}


/* ---------- PAGE FLOW ---------- */
trigger.onclick = () => {
    if(state===0) {
        if(savedMovies.length === 0) openArchive();
        else { state=1; buildCircle(); }
    } else if (state===1) {
        openArchive();
    }
};

ret.onclick = () => {
    archive.style.display="none";
    trigger.style.display="block";
    gsap.to(ret,{opacity:0,pointerEvents:"none"});
    
    if(savedMovies.length > 0) {
        state=1;
        buildCircle();
    } else {
        state=0;
        circle.innerHTML="";
    }
};

function openArchive(){
    state=2;
    trigger.style.display="none";
    gsap.to(circleItems,{opacity:0,scale:0,onComplete:()=>circle.innerHTML=""});
    archive.style.display="block";
    gsap.to(ret,{opacity:1,pointerEvents:"auto"});
    renderSaved();
    
    if(savedMovies.length===0 && !isSharedMode){
        searchBar.classList.add("active");
        searchInput.focus();
    }
}

/* ---------- CIRCLE EFFECTS RESTORED ---------- */
const RADIUS=260;

function buildCircle(){
    circle.innerHTML="";
    circleItems = []; // Reset array
    if(savedMovies.length===0) return;
    const limit = savedMovies.slice(-12);

    limit.forEach((m,i)=>{
        const el=document.createElement("div");
        el.className="poster";
        el.style.backgroundImage=`url(${hiRes(m.Poster)})`;
        circle.appendChild(el);
        circleItems.push(el); // Add to tracking array
        
        const a=i/limit.length*Math.PI*2-Math.PI/2;
        const x=Math.cos(a)*RADIUS;
        const y=Math.sin(a)*RADIUS;
        el.dataset.x=x;
        el.dataset.y=y;
        
        gsap.set(el,{x:0,y:0,scale:.8,opacity:0});
        gsap.to(el,{x,y,scale:1,opacity:1,duration:1.2,delay:i*.08});
        
        // --- RESTORED HOVER EFFECT ---
        el.onmouseenter=()=>{
            try{ hoverSound.currentTime=0; hoverSound.play(); }catch(e){}
            // Dim others
            circleItems.forEach(p => {
                if(p !== el) gsap.to(p, {opacity: 0.15, duration: 0.3});
            });
            // Scale active
            gsap.to(el, {x:x*1.15, y:y*1.15, scale:1.12, duration: 0.4});
        };
        
        el.onmouseleave=()=>{
            // Restore others
            circleItems.forEach(p => gsap.to(p, {opacity: 1, duration: 0.3}));
            // Restore active
            gsap.to(el, {x, y, scale: 1, duration: 0.4});
        };
    });
}

/* ---------- GRID EFFECTS RESTORED ---------- */
function renderSaved(){
    grid.innerHTML="";
    savedMovies.forEach(m=>{
        const el=document.createElement("div");
        el.className="grid-item";
        el.style.backgroundImage=`url(${hiRes(m.Poster)})`;
        
        if(!isSharedMode){
            el.oncontextmenu=e=>{
                e.preventDefault();
                removeMovie(m.imdbID);
            };
        }
        grid.appendChild(el);
    });
    enableGridFocus(); // ACTIVATE EFFECTS
}

function enableGridFocus(){
  const items=document.querySelectorAll(".grid-item");
  items.forEach(i=>{
    i.onmouseenter=()=>{
      // Dim others
      items.forEach(o=>o!==i&&gsap.to(o,{opacity:0.2, duration:0.3}));
      // Scale active
      gsap.to(i,{scale:1.08, duration:0.3});
    };
    i.onmouseleave=()=>{
      // Restore all
      items.forEach(o=>gsap.to(o,{opacity:1, duration:0.3}));
      gsap.to(i,{scale:1, duration:0.3});
    };
  });
}

/* ---------- SEARCH & SAVE ---------- */
searchIcon.onclick=()=>{
  if(isSharedMode) return;
  searchBar.classList.toggle("active");
  searchInput.focus();
};

let timer;
searchInput.oninput=()=>{
  clearTimeout(timer);
  timer=setTimeout(searchMovies,400);
};

async function searchMovies(){
  if(isSharedMode) return;

  let rawQ = searchInput.value.trim();
  if(rawQ.length<2){ searchResults.innerHTML=""; return; }
  let cleanQ = rawQ.toLowerCase();
  
  let titleSearch = cleanQ;
  let yearSearch = "";
  const yearMatch = cleanQ.match(/^(.+?)\s+(\d{4})$/);
  if(yearMatch) {
    titleSearch = yearMatch[1].trim(); 
    yearSearch = yearMatch[2];
  }

  const smartAliases = {
    "seven": "se7en", "aot": "attack on titan", "got": "game of thrones",
    "lotr": "lord of the rings", "op": "one piece", "jjk": "jujutsu kaisen",
    "bb": "breaking bad", "bcs": "better call saul", "himym": "how i met your mother"
  };
  titleSearch = smartAliases[titleSearch] || titleSearch;

  let url = `https://www.omdbapi.com/?apikey=${OMDB_KEY}&s=${encodeURIComponent(titleSearch)}`;
  if(yearSearch) url += `&y=${yearSearch}`;

  let r = await fetch(url);
  let d = await r.json();

  // Fallback Logic
  if(d.Response === "False") {
    let exactUrl = `https://www.omdbapi.com/?apikey=${OMDB_KEY}&t=${encodeURIComponent(titleSearch)}`;
    if(yearSearch) exactUrl += `&y=${yearSearch}`;
    let r2 = await fetch(exactUrl);
    let d2 = await r2.json();
    if(d2.Response === "True") {
      d = { Response: "True", Search: [d2] };
    } else {
       if(yearSearch) {
          let fallbackUrl = `https://www.omdbapi.com/?apikey=${OMDB_KEY}&s=${encodeURIComponent(titleSearch)}`;
          let r3 = await fetch(fallbackUrl);
          d = await r3.json();
       }
    }
  }
  
  searchResults.innerHTML="";
  if(d.Response==="False" || !d.Search) return;

  d.Search.forEach(m=>{
    const el=document.createElement("div");
    el.className="grid-item";
    el.style.backgroundImage=`url(${hiRes(m.Poster)})`;
    el.onclick=()=>saveMovie(m); 
    searchResults.appendChild(el);
  });
  
  // Re-enable focus for search results too
  enableGridFocus();
}

function saveMovie(movie){
    if(isSharedMode) {
        alert("You are in SHARED MODE. Click 'IMPORT' to add this list to your own.");
        return;
    }
    if(savedMovies.find(m=>m.imdbID===movie.imdbID)) return;
    
    savedMovies.push(movie);
    localStorage.setItem("savedMovies",JSON.stringify(savedMovies));
    renderSaved();
}

function removeMovie(id){
    if(isSharedMode) return;
    savedMovies=savedMovies.filter(m=>m.imdbID!==id);
    localStorage.setItem("savedMovies",JSON.stringify(savedMovies));
    renderSaved();
}

/* ---------- BUTTON ACTIONS ---------- */
shareBtn.onclick = async () => {
    if(!window.db) return alert("Loading...");
    
    if(isSharedMode) {
        await navigator.clipboard.writeText(location.href);
        alert("Link Copied!");
        return;
    }

    if(savedMovies.length===0) return alert("List is empty.");
    
    const id = Math.random().toString(36).substring(2,8);
    await window.setDoc(window.doc(window.db,"shares",id), {
        movies: savedMovies,
        createdAt: Date.now()
    });
    
    const link = `${location.origin}${location.pathname}?view=${id}`;
    await navigator.clipboard.writeText(link);
    alert("Share Link Copied!");
};

importBtn.onclick = () => {
    if(!isSharedMode) return;
    
    const choice = confirm("Merge these shared movies into your personal list?");
    if(choice) {
        let myData = [];
        try { myData = JSON.parse(localStorage.getItem("savedMovies")) || []; } catch(e){}
        
        const combined = [...myData, ...savedMovies];
        const unique = combined.filter((obj, index, self) =>
            index === self.findIndex((t) => t.imdbID === obj.imdbID)
        );
        
        localStorage.setItem("savedMovies", JSON.stringify(unique));
        alert("Imported Successfully!");
        exitSharedMode();
    }
};
</script>
</body>
</html>